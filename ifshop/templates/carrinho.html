{% extends 'base.html' %}

{% load static %}
{% load crispy_forms_filters %}

{% block title %}Carrinho{% endblock %}
{% block filtro %}{% endblock %}

{% block content %}
  {% if user.is_authenticated %}
    {% if pedidos_feitos %}
      <div class="container mx-auto row m-0">
        {% for item in pedidos_feitos %}
          {% with pedido=item.pedido imagens=item.imagem_principal camisetas=item.camisetas %}
          <div class="col-md-12 col-sm-12 col-lg-6 mb-4">

            <!-- Modal para pagamento físico (id único por pedido) -->
            <div class="modal fade" id="exampleModal_fisico_{{ pedido.id }}" tabindex="-1" aria-labelledby="exampleModalLabel{{ pedido.id }}" aria-hidden="true">
              <div class="modal-dialog">
                <div class="modal-content">
                  <div class="modal-header">
                    <h4>
                      Você escolheu pagar fisicamente. Procure por {{ pedido.produto.vendedor.nome }}.
                    </h4>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                  </div>
                </div>
              </div>
            </div>

            <!-- Pedido -->
            <div style="border: 1px solid #ddd; padding: 10px; display:flex; align-items:center; justify-content:space-between;">
              <div class="row w-100">

                <!-- Imagem -->
                <div class="col-md-3 col-sm-12 col-lg-6 d-flex align-items-center">
                  {% if imagens %}
                    <img src="{{ imagens.imagem.url }}" alt="Imagem de {{ pedido.produto.titulo }}" class="thumbnail img-fluid mx-auto w-100" />
                  {% else %}
                    <img src="{% static 'img/não_tem_imagem.svg' %}" alt="Sem imagem" class="thumbnail img-fluid mx-auto w-100" />
                  {% endif %}
                </div>

                <!-- Informações -->
                <div class="col-md-9 col-sm-12 col-lg-6">
                  <div class="pb-3">
                    <h3><strong>{{ pedido.produto.titulo }}</strong></h3>
                    <p class="small">
                      Data limite p/ pagamento total ou 1ª parcela: {{ pedido.produto.data_pag1 }}
                    </p>
                    {% if pedido.produto.data_pag2 %}
                      <p class="small">Data limite p/ 2ª parcela: {{ pedido.produto.data_pag2 }}</p>
                    {% else %}
                      <p class="small">Data limite p/ 2ª parcela: à definir</p>
                    {% endif %}
                    <p>Status: {{ pedido.status }}</p>
                  </div>

                  <div class="row">
                    <!-- Se for pedido de camiseta: mostra cada PedidoCamiseta ligado a este PedidoBase -->
                    {% if camisetas %}
                      {% for pc in camisetas %}
                        <div class="col-12 col-md-6">
                          <strong>Nome:</strong> {{ pc.nome_estampa }}<br />
                          <strong>Número:</strong> {{ pc.numero_estampa }}<br />
                          <strong>Tamanho:</strong> {{ pc.tamanho }}<br />
                        </div>
                        <div class="col-12 col-md-6">
                          <strong>Estilo:</strong> {{ pc.estilo }}<br />
                          <strong>Preço:</strong> R$ {{ pedido.produto.preco }}<br />
                          <strong>Opção:</strong> {{ pedido.opcao_escolhida }}<br />
                        </div>
                      {% endfor %}
                    {% else %}
                      <!-- Produto genérico -->
                      <div class="col-12 col-md-6">
                        <strong>Preço:</strong> R$ {{ pedido.produto.preco }}<br />
                        <strong>Opção:</strong> {{ pedido.opcao_escolhida }}<br />
                      </div>
                    {% endif %}

                    <!-- Botões -->
                    <div class="col-12 col-md-6 mt-3">
                      <div class="d-flex flex-wrap gap-2">

                        {% if pedido.forma_pag == "Pix" or pedido.forma_pag == "Parcelado 2x Pix" %}
                          <a href="{% url 'comprovantes' pedido.id %}" class="btn botoes rounded-pill shadow-lg">Pagar</a>
                        {% elif pedido.forma_pag == "Negociar Pagamento" %}
                          <a href="https://wa.me/55{{ pedido.produto.vendedor.telefone }}?text=Olá!%20Gostaria%20de%20negociar%20o%20pagamento%20do%20produto%20{{ pedido.produto.titulo }},%20Pedido%20ID:%20{{ pedido.id }}" class="btn botoes rounded-pill shadow-lg">
                            Negociar Pagamento
                          </a>
                        {% else %}
                          <button class="btn botoes rounded-pill shadow-lg" data-bs-toggle="modal" data-bs-target="#exampleModal_fisico_{{ pedido.id }}">Veja como pagar</button>
                        {% endif %}

                        {# botão editar: só permitir se data_limite_pedidos ainda não passou #}
                        {% if pedido.produto.data_limite_pedidos and pedido.produto.data_limite_pedidos <= hoje %}
                          <button class="btn btn-secondary" disabled>Editar (Indisponível)</button>
                        {% else %}
                          {% if camisetas %}
                            {# para pedidos de camiseta: editar cada PedidoCamiseta individualmente #}
                            {% for pc in camisetas %}
                              <a href="{% url 'edit_pedido_camiseta' pc.id %}" class="btn btn-warning text-white rounded-pill">Editar</a>
                            {% endfor %}
                          {% else %}
                            <a href="{% url 'edit_pedido_produto' pedido.id %}" class="btn btn-warning text-white rounded-pill">Editar</a>
                          {% endif %}
                        {% endif %}

                        {# cancelar pedido (vai para sua view de excluir_pedido) #}
                        <a href="{% url 'excluir_pedido' pedido.id %}" class="btn btn-danger rounded-pill">Cancelar</a>

                      </div>
                    </div>
                  </div>
                </div>

              </div>
            </div>

          </div>
          {% endwith %}
        {% endfor %}
      </div>
    {% else %}
      <h3>Você ainda não adicionou nada ao carrinho.</h3>
    {% endif %}
  {% else %}
    <p>Você precisa estar logado para ver seus pedidos.</p>
  {% endif %}
{% endblock %}
